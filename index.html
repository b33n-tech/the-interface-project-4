<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data Sculptor</title>

<!-- UI / libs -->
<script src="https://cdn.tailwindcss.com"></script>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- Data -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Word export -->
<script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>
</head>

<body class="bg-slate-50">
<div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect } = React;

/* ---------- Icons ---------- */
const Upload = () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>;
const Trash2 = () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/></svg>;
const Edit3 = () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4z"/></svg>;
const Plus = () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
const Save = () => <svg width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21H5a2 2 0 0 1-2-2V5h11l5 5z"/></svg>;
const FolderOpen = () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 19H4V5h5l2 3h11z"/></svg>;

/* ---------- Chart Block ---------- */
const ChartBlock = ({ data }) => {
    const ref = useRef(null);

    useEffect(() => {
        if (!ref.current) return;
        const ctx = ref.current.getContext("2d");
        let chart;

        if (data.chart === "bar" || data.chart === "pie") {
            chart = new Chart(ctx, {
                type: data.chart,
                data: {
                    labels: data.value.map(v => v[0]),
                    datasets: [{
                        data: data.value.map(v => v[1]),
                        backgroundColor: [
                            "#3B82F6","#F97316","#10B981",
                            "#EF4444","#8B5CF6","#F59E0B"
                        ]
                    }]
                },
                options: { responsive: true, plugins:{ legend:{ display:false }} }
            });
        }

        return () => chart && chart.destroy();
    }, [data]);

    return <canvas ref={ref} height="160"></canvas>;
};

/* ---------- App ---------- */
const DataSculptor = () => {
    const [data, setData] = useState([]);
    const [columns, setColumns] = useState([]);
    const [blocks, setBlocks] = useState([]);
    const [activeBlockId, setActiveBlockId] = useState(null);

    const fileInput = useRef(null);

    useEffect(() => {
        const close = () => setActiveBlockId(null);
        window.addEventListener("click", close);
        return () => window.removeEventListener("click", close);
    }, []);

    const calculateKPI = (b, rows = data) => {
        if (b.operation === "count") return rows.length;
        const values = rows.map(r => r[b.column]).filter(v => v !== "" && v != null);

        if (b.type === "number") {
            const nums = values.map(Number).filter(n => !isNaN(n));
            if (!nums.length) return 0;
            if (b.operation === "sum") return nums.reduce((a,b)=>a+b,0).toFixed(2);
            if (b.operation === "avg") return (nums.reduce((a,b)=>a+b,0)/nums.length).toFixed(2);
            if (b.operation === "max") return Math.max(...nums).toFixed(2);
            if (b.operation === "min") return Math.min(...nums).toFixed(2);
        }

        if (b.type === "list") {
            const counts = {};
            values.forEach(v => counts[v] = (counts[v]||0)+1);
            return Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,10);
        }
        return 0;
    };

    const handleFileUpload = e => {
        const f = e.target.files[0];
        if (!f) return;

        const reader = new FileReader();
        reader.onload = ev => {
            const wb = XLSX.read(new Uint8Array(ev.target.result), {type:"array"});
            const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            const cols = Object.keys(json[0] || {});
            setColumns(cols);
            setData(json);

            setBlocks([
                { id:0, title:"Nombre de lignes", type:"number", operation:"count", value:json.length },
                ...(cols.map((c,i)=>({
                    id:i+1,
                    title:`Total ${c}`,
                    type:"number",
                    column:c,
                    operation:"sum",
                    value:calculateKPI({type:"number",column:c,operation:"sum"},json)
                })))
            ]);
        };
        reader.readAsArrayBuffer(f);
    };

    /* ---------- Word export ---------- */
    const handleExportWord = async () => {
        const { Document, Packer, Paragraph, HeadingLevel, TextRun } = window.docx;
        const children = [];

        children.push(new Paragraph({ text:"Data Sculptor â€“ KPIs", heading:HeadingLevel.TITLE }));
        children.push(new Paragraph({ text:`ExportÃ© le ${new Date().toLocaleString()}` }));

        blocks.forEach(b => {
            children.push(new Paragraph({ text:b.title, heading:HeadingLevel.HEADING_2 }));

            if (b.type === "number") {
                children.push(new Paragraph({
                    children:[ new TextRun({ text:String(b.value), bold:true }) ]
                }));
            }

            if (b.type === "list") {
                b.value.forEach(([l,v]) =>
                    children.push(new Paragraph({ text:`â€¢ ${l} : ${v}` }))
                );
            }
        });

        const doc = new Document({ sections:[{ children }] });
        const blob = await Packer.toBlob(doc);

        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "data-sculptor-kpis.docx";
        a.click();
    };

    /* ---------- Render block ---------- */
    const renderBlock = b => {
        const active = activeBlockId === b.id;

        return (
            <div
                key={b.id}
                onClick={() => setActiveBlockId(b.id)}
                onContextMenu={e => { e.preventDefault(); setActiveBlockId(b.id); }}
                className={`relative bg-white p-6 rounded-lg border cursor-pointer transition
                    ${active ? "ring-2 ring-blue-400 shadow-lg" : "hover:shadow-md"}`}
            >
                {active && (
                    <div className="absolute inset-0 bg-white/70 backdrop-blur-sm flex items-center justify-center gap-4 z-10 rounded-lg">
                        <button className="px-4 py-2 bg-blue-500 text-white rounded-lg flex gap-2">
                            <Edit3/> Modifier
                        </button>
                        <button
                            onClick={e => { e.stopPropagation(); setBlocks(blocks.filter(x=>x.id!==b.id)); }}
                            className="px-4 py-2 bg-red-500 text-white rounded-lg flex gap-2"
                        >
                            <Trash2/> Supprimer
                        </button>
                    </div>
                )}

                <div className={active ? "opacity-30" : ""}>
                    <div className="text-sm text-gray-500 mb-2">{b.title}</div>
                    {b.type === "number" && <div className="text-3xl font-bold">{b.value}</div>}
                    {b.type === "list" && b.chart && <ChartBlock data={b}/>}
                </div>
            </div>
        );
    };

    return (
        <div className="p-8 max-w-7xl mx-auto">
            <h1 className="text-3xl font-bold mb-4">Data Sculptor</h1>

            <div className="flex gap-3 mb-6">
                <button onClick={()=>fileInput.current.click()} className="bg-blue-500 text-white px-4 py-2 rounded-lg flex gap-2">
                    <Upload/> Upload fichier
                </button>
                <input ref={fileInput} type="file" hidden accept=".xlsx,.csv" onChange={handleFileUpload}/>
                <button onClick={handleExportWord} className="bg-gray-900 text-white px-4 py-2 rounded-lg">
                    ðŸ“„ TÃ©lÃ©charger Word
                </button>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {blocks.map(renderBlock)}
            </div>
        </div>
    );
};

ReactDOM.createRoot(document.getElementById("root")).render(<DataSculptor/>);
</script>
</body>
</html>
