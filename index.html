<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data Sculptor</title>

<script src="https://cdn.tailwindcss.com"></script>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>
</head>

<body class="bg-slate-50">
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

/* ================= Icons ================= */
const Upload = () => <span>‚¨ÜÔ∏è</span>;
const Plus = () => <span>‚ûï</span>;
const Trash = () => <span>üóëÔ∏è</span>;
const Edit = () => <span>‚úèÔ∏è</span>;

/* ================= Chart ================= */
const ChartBlock = ({ value, chart }) => {
    const ref = useRef(null);
    const chartInstance = useRef(null);

    useEffect(() => {
        if (!ref.current || !chart || !value || value.length === 0) return;
        
        // D√©truire l'instance pr√©c√©dente si elle existe
        if (chartInstance.current) {
            chartInstance.current.destroy();
        }

        const ctx = ref.current.getContext("2d");

        chartInstance.current = new Chart(ctx, {
            type: chart,
            data: {
                labels: value.map(v => v[0]),
                datasets: [{
                    data: value.map(v => v[1]),
                    backgroundColor: [
                        "#3B82F6","#F97316","#10B981",
                        "#EF4444","#8B5CF6","#F59E0B"
                    ]
                }]
            },
            options: { responsive:true, plugins:{ legend:{ display:false }} }
        });

        return () => {
            if (chartInstance.current) {
                chartInstance.current.destroy();
            }
        };
    }, [value, chart]);

    return <canvas ref={ref} height="160"></canvas>;
};

/* ================= App ================= */
const DataSculptor = () => {
    const [data, setData] = useState([]);
    const [columns, setColumns] = useState([]);
    const [blocks, setBlocks] = useState([]);
    const [activeId, setActiveId] = useState(null);
    const [draggedId, setDraggedId] = useState(null);
    const [editingId, setEditingId] = useState(null);
    const [editForm, setEditForm] = useState({});

    const fileInput = useRef(null);

    /* -------- Close overlay on outside click -------- */
    useEffect(() => {
        const close = (e) => {
            // Ne fermer que si le clic est en dehors d'un block
            if (!e.target.closest('.block-container') && !e.target.closest('.edit-modal')) {
                setActiveId(null);
                setEditingId(null);
            }
        };
        window.addEventListener("click", close);
        return () => window.removeEventListener("click", close);
    }, []);

    /* ================= KPI CALC ================= */
    const calculateKPI = (block) => {
        if (!data.length) return block.type === "list" ? [] : 0;

        if (block.operation === "count") return data.length;

        const values = data
            .map(r => r[block.column])
            .filter(v => v !== null && v !== undefined && v !== "");

        if (block.type === "number") {
            const nums = values.map(Number).filter(n => !isNaN(n));
            if (!nums.length) return 0;

            if (block.operation === "sum") return nums.reduce((a,b)=>a+b,0).toFixed(2);
            if (block.operation === "avg") return (nums.reduce((a,b)=>a+b,0)/nums.length).toFixed(2);
            if (block.operation === "max") return Math.max(...nums).toFixed(2);
            if (block.operation === "min") return Math.min(...nums).toFixed(2);
        }

        if (block.type === "list") {
            const counts = {};
            values.forEach(v => counts[v] = (counts[v] || 0) + 1);
            return Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,10);
        }

        return 0;
    };

    /* ================= Upload ================= */
    const handleFileUpload = e => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = ev => {
            try {
                const wb = XLSX.read(new Uint8Array(ev.target.result), { type:"array" });
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                if (!json.length) {
                    alert("Le fichier ne contient pas de donn√©es");
                    return;
                }

                setData(json);
                setColumns(Object.keys(json[0]));

                // KPIs de base
                setBlocks([
                    {
                        id: Date.now(),
                        title: "Nombre de lignes",
                        type: "number",
                        operation: "count"
                    }
                ]);
            } catch (error) {
                console.error("Erreur lors de la lecture du fichier:", error);
                alert("Erreur lors de la lecture du fichier");
            }
        };
        reader.onerror = () => {
            alert("Erreur lors de la lecture du fichier");
        };
        reader.readAsArrayBuffer(file);
        
        // R√©initialiser l'input pour permettre de charger le m√™me fichier
        e.target.value = '';
    };

    /* ================= Add Block ================= */
    const handleAddBlock = () => {
        if (!columns.length) {
            alert("Veuillez d'abord charger un fichier");
            return;
        }

        setBlocks(prev => [
            ...prev,
            {
                id: Date.now(),
                title: "Nouvelle data",
                type: "number",
                column: columns[0],
                operation: "sum"
            }
        ]);
    };

    /* ================= Drag & Drop ================= */
    const onDragStart = (e, id) => {
        setDraggedId(id);
        e.dataTransfer.effectAllowed = "move";
    };

    const onDragOver = (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
    };

    const onDrop = (e, targetId) => {
        e.preventDefault();
        if (draggedId === targetId) return;
        
        const from = blocks.findIndex(b => b.id === draggedId);
        const to = blocks.findIndex(b => b.id === targetId);
        if (from === -1 || to === -1) return;

        const updated = [...blocks];
        const [moved] = updated.splice(from, 1);
        updated.splice(to, 0, moved);
        setBlocks(updated);
        setDraggedId(null);
    };

    const onDragEnd = () => {
        setDraggedId(null);
    };

    /* ================= Edit Block ================= */
    const handleEditBlock = (block) => {
        setEditForm({
            id: block.id,
            title: block.title,
            type: block.type,
            column: block.column || columns[0],
            operation: block.operation,
            chart: block.chart || ""
        });
        setEditingId(block.id);
        setActiveId(null);
    };

    const handleSaveEdit = () => {
        setBlocks(prev => prev.map(b => 
            b.id === editForm.id ? { ...editForm } : b
        ));
        setEditingId(null);
        setEditForm({});
    };

    const handleCancelEdit = () => {
        setEditingId(null);
        setEditForm({});
    };

    /* ================= Export Word ================= */
    const handleExportWord = async () => {
        if (!blocks.length) {
            alert("Aucune donn√©e √† exporter");
            return;
        }

        try {
            const { Document, Packer, Paragraph, HeadingLevel } = window.docx;
            const children = [
                new Paragraph({ text:"Data Sculptor ‚Äì KPIs", heading:HeadingLevel.TITLE }),
                new Paragraph({ text:`Export√© le ${new Date().toLocaleString('fr-FR')}` })
            ];

            blocks.forEach(b => {
                const value = calculateKPI(b);
                children.push(new Paragraph({ text:b.title, heading:HeadingLevel.HEADING_2 }));

                if (b.type === "list") {
                    if (value.length === 0) {
                        children.push(new Paragraph({ text:"Aucune donn√©e" }));
                    } else {
                        value.forEach(([l,v]) =>
                            children.push(new Paragraph({ text:`‚Ä¢ ${l} : ${v}` }))
                        );
                    }
                } else {
                    children.push(new Paragraph({ text:String(value) }));
                }
            });

            const doc = new Document({ sections:[{ children }] });
            const blob = await Packer.toBlob(doc);

            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "data-sculptor-kpis.docx";
            a.click();
            
            // Nettoyer l'URL cr√©√©e
            setTimeout(() => URL.revokeObjectURL(a.href), 100);
        } catch (error) {
            console.error("Erreur lors de l'export Word:", error);
            alert("Erreur lors de l'export Word");
        }
    };

    /* ================= Block ================= */
    const renderBlock = b => {
        const active = activeId === b.id;
        const value = calculateKPI(b);

        return (
            <div
                key={b.id}
                draggable
                onDragStart={(e) => onDragStart(e, b.id)}
                onDragOver={onDragOver}
                onDrop={(e) => onDrop(e, b.id)}
                onDragEnd={onDragEnd}
                onClick={(e) => {
                    e.stopPropagation();
                    setActiveId(b.id);
                }}
                onContextMenu={e => { 
                    e.preventDefault(); 
                    e.stopPropagation();
                    setActiveId(b.id); 
                }}
                className={`block-container relative bg-white p-6 rounded-lg border cursor-move transition
                    ${active ? "ring-2 ring-blue-400 shadow-lg" : "hover:shadow-md"}`}
            >
                {active && (
                    <div 
                        className="absolute inset-0 bg-white/70 flex items-center justify-center gap-4 z-10"
                        onClick={(e) => e.stopPropagation()}
                    >
                        <button 
                            className="bg-blue-500 text-white px-4 py-2 rounded-lg flex gap-2"
                            onClick={(e) => {
                                e.stopPropagation();
                                handleEditBlock(b);
                            }}
                        >
                            <Edit/> Modifier
                        </button>
                        <button
                            onClick={e => {
                                e.stopPropagation();
                                setBlocks(blocks.filter(x => x.id !== b.id));
                                setActiveId(null);
                            }}
                            className="bg-red-500 text-white px-4 py-2 rounded-lg flex gap-2"
                        >
                            <Trash/> Supprimer
                        </button>
                    </div>
                )}

                <div className={active ? "opacity-30" : ""}>
                    <div className="text-sm text-gray-500 mb-2">{b.title}</div>

                    {b.type === "number" && (
                        <div className="text-3xl font-bold">{value}</div>
                    )}

                    {b.type === "list" && b.chart && (
                        <ChartBlock value={value} chart={b.chart}/>
                    )}

                    {b.type === "list" && !b.chart && (
                        <div className="space-y-1">
                            {value.length === 0 ? (
                                <div className="text-gray-400">Aucune donn√©e</div>
                            ) : (
                                value.map(([label, count]) => (
                                    <div key={label} className="text-sm">
                                        {label}: {count}
                                    </div>
                                ))
                            )}
                        </div>
                    )}
                </div>
            </div>
        );
    };

    return (
        <div className="p-8 max-w-7xl mx-auto">
            <h1 className="text-3xl font-bold mb-4">Data Sculptor</h1>

            {/* Edit Modal */}
            {editingId && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                    <div 
                        className="edit-modal bg-white rounded-lg p-6 max-w-md w-full mx-4"
                        onClick={(e) => e.stopPropagation()}
                    >
                        <h2 className="text-xl font-bold mb-4">Modifier le module</h2>
                        
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium mb-1">Titre</label>
                                <input
                                    type="text"
                                    value={editForm.title}
                                    onChange={(e) => setEditForm({...editForm, title: e.target.value})}
                                    className="w-full border rounded px-3 py-2"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium mb-1">Type</label>
                                <select
                                    value={editForm.type}
                                    onChange={(e) => setEditForm({...editForm, type: e.target.value})}
                                    className="w-full border rounded px-3 py-2"
                                >
                                    <option value="number">Nombre</option>
                                    <option value="list">Liste</option>
                                </select>
                            </div>

                            {editForm.operation !== "count" && (
                                <div>
                                    <label className="block text-sm font-medium mb-1">Colonne</label>
                                    <select
                                        value={editForm.column}
                                        onChange={(e) => setEditForm({...editForm, column: e.target.value})}
                                        className="w-full border rounded px-3 py-2"
                                    >
                                        {columns.map(col => (
                                            <option key={col} value={col}>{col}</option>
                                        ))}
                                    </select>
                                </div>
                            )}

                            <div>
                                <label className="block text-sm font-medium mb-1">Op√©ration</label>
                                <select
                                    value={editForm.operation}
                                    onChange={(e) => setEditForm({...editForm, operation: e.target.value})}
                                    className="w-full border rounded px-3 py-2"
                                >
                                    <option value="count">Compter</option>
                                    {editForm.type === "number" && (
                                        <>
                                            <option value="sum">Somme</option>
                                            <option value="avg">Moyenne</option>
                                            <option value="max">Maximum</option>
                                            <option value="min">Minimum</option>
                                        </>
                                    )}
                                </select>
                            </div>

                            {editForm.type === "list" && (
                                <div>
                                    <label className="block text-sm font-medium mb-1">Graphique</label>
                                    <select
                                        value={editForm.chart}
                                        onChange={(e) => setEditForm({...editForm, chart: e.target.value})}
                                        className="w-full border rounded px-3 py-2"
                                    >
                                        <option value="">Aucun</option>
                                        <option value="bar">Barres</option>
                                        <option value="pie">Camembert</option>
                                        <option value="doughnut">Donut</option>
                                    </select>
                                </div>
                            )}
                        </div>

                        <div className="flex gap-3 mt-6">
                            <button
                                onClick={handleSaveEdit}
                                className="flex-1 bg-blue-500 text-white px-4 py-2 rounded-lg"
                            >
                                Enregistrer
                            </button>
                            <button
                                onClick={handleCancelEdit}
                                className="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg"
                            >
                                Annuler
                            </button>
                        </div>
                    </div>
                </div>
            )}

            <div className="flex gap-3 mb-6">
                <button
                    onClick={() => fileInput.current?.click()}
                    className="bg-blue-500 text-white px-4 py-2 rounded-lg flex items-center gap-2"
                >
                    <Upload/> Upload fichier
                </button>
                <input 
                    ref={fileInput} 
                    type="file" 
                    accept=".xlsx,.xls,.csv"
                    hidden 
                    onChange={handleFileUpload}
                />

                <button
                    onClick={handleAddBlock}
                    disabled={!columns.length}
                    className={`px-4 py-2 rounded-lg flex items-center gap-2 ${
                        columns.length 
                            ? "bg-indigo-500 text-white hover:bg-indigo-600" 
                            : "bg-gray-300 text-gray-500 cursor-not-allowed"
                    }`}
                >
                    <Plus/> Ajouter une data
                </button>

                <button
                    onClick={handleExportWord}
                    disabled={!blocks.length}
                    className={`px-4 py-2 rounded-lg flex items-center gap-2 ${
                        blocks.length 
                            ? "bg-gray-900 text-white hover:bg-gray-800" 
                            : "bg-gray-300 text-gray-500 cursor-not-allowed"
                    }`}
                >
                    üìÑ T√©l√©charger Word
                </button>
            </div>

            {blocks.length === 0 && data.length === 0 && (
                <div className="text-center text-gray-400 py-12">
                    Chargez un fichier Excel pour commencer
                </div>
            )}

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {blocks.map(renderBlock)}
            </div>
        </div>
    );
};

ReactDOM.createRoot(document.getElementById("root")).render(<DataSculptor/>);
</script>
</body>
</html>
