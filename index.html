<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data Sculptor</title>

<script src="https://cdn.tailwindcss.com"></script>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>
</head>

<body class="bg-slate-50">
<div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect } = React;

/* ---------- Icons ---------- */
const Upload = () => <span>‚¨ÜÔ∏è</span>;
const Trash2 = () => <span>üóëÔ∏è</span>;
const Edit3 = () => <span>‚úèÔ∏è</span>;
const Plus = () => <span>‚ûï</span>;

/* ---------- Chart ---------- */
const ChartBlock = ({ data }) => {
    const ref = useRef(null);

    useEffect(() => {
        if (!ref.current) return;
        const ctx = ref.current.getContext("2d");

        const chart = new Chart(ctx, {
            type: data.chart,
            data: {
                labels: data.value.map(v => v[0]),
                datasets: [{
                    data: data.value.map(v => v[1]),
                    backgroundColor: ["#3B82F6","#F97316","#10B981","#EF4444","#8B5CF6"]
                }]
            },
            options:{ responsive:true, plugins:{ legend:{ display:false }}}
        });

        return () => chart.destroy();
    }, [data]);

    return <canvas ref={ref} height="150"></canvas>;
};

/* ---------- App ---------- */
const DataSculptor = () => {
    const [data, setData] = useState([]);
    const [columns, setColumns] = useState([]);
    const [blocks, setBlocks] = useState([]);
    const [activeBlockId, setActiveBlockId] = useState(null);
    const [draggedId, setDraggedId] = useState(null);

    const fileInput = useRef(null);

    useEffect(() => {
        const close = () => setActiveBlockId(null);
        window.addEventListener("click", close);
        return () => window.removeEventListener("click", close);
    }, []);

    /* ---------- KPI ---------- */
    const calculateKPI = (b) => {
        if (b.operation === "count") return data.length;
        const values = data.map(r => r[b.column]).filter(v => v != null && v !== "");

        if (b.type === "number") {
            const nums = values.map(Number).filter(n => !isNaN(n));
            if (!nums.length) return 0;
            if (b.operation === "sum") return nums.reduce((a,b)=>a+b,0).toFixed(2);
            if (b.operation === "avg") return (nums.reduce((a,b)=>a+b,0)/nums.length).toFixed(2);
        }

        if (b.type === "list") {
            const counts = {};
            values.forEach(v => counts[v] = (counts[v]||0)+1);
            return Object.entries(counts).slice(0,10);
        }
        return 0;
    };

    /* ---------- Upload ---------- */
    const handleFileUpload = e => {
        const f = e.target.files[0];
        if (!f) return;

        const reader = new FileReader();
        reader.onload = ev => {
            const wb = XLSX.read(new Uint8Array(ev.target.result), {type:"array"});
            const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            setData(json);
            setColumns(Object.keys(json[0] || {}));
        };
        reader.readAsArrayBuffer(f);
    };

    /* ---------- Add block ---------- */
    const handleAddBlock = () => {
        const newBlock = {
            id: Date.now(),
            title: "Nouvelle data",
            type: "number",
            operation: "count",
            value: data.length
        };
        setBlocks([...blocks, newBlock]);
    };

    /* ---------- Drag & drop ---------- */
    const onDrop = (targetId) => {
        const srcIndex = blocks.findIndex(b => b.id === draggedId);
        const tgtIndex = blocks.findIndex(b => b.id === targetId);
        if (srcIndex === -1 || tgtIndex === -1) return;

        const updated = [...blocks];
        const [moved] = updated.splice(srcIndex, 1);
        updated.splice(tgtIndex, 0, moved);
        setBlocks(updated);
    };

    /* ---------- Export Word ---------- */
    const handleExportWord = async () => {
        const { Document, Packer, Paragraph, HeadingLevel } = window.docx;
        const children = [
            new Paragraph({ text:"Data Sculptor ‚Äì KPIs", heading:HeadingLevel.TITLE })
        ];

        blocks.forEach(b => {
            children.push(new Paragraph({ text:b.title, heading:HeadingLevel.HEADING_2 }));
            children.push(new Paragraph({ text:String(b.value) }));
        });

        const doc = new Document({ sections:[{ children }] });
        const blob = await Packer.toBlob(doc);
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "kpis.docx";
        a.click();
    };

    /* ---------- Block ---------- */
    const renderBlock = b => {
        const active = activeBlockId === b.id;

        return (
            <div
                key={b.id}
                draggable
                onDragStart={() => setDraggedId(b.id)}
                onDragOver={e => e.preventDefault()}
                onDrop={() => onDrop(b.id)}
                onClick={() => setActiveBlockId(b.id)}
                onContextMenu={e => { e.preventDefault(); setActiveBlockId(b.id); }}
                className={`relative bg-white p-6 rounded-lg border cursor-move transition
                    ${active ? "ring-2 ring-blue-400 shadow-lg" : "hover:shadow-md"}`}
            >
                {active && (
                    <div className="absolute inset-0 bg-white/70 flex items-center justify-center gap-4 z-10">
                        <button className="bg-blue-500 text-white px-3 py-2 rounded-lg"><Edit3/> Modifier</button>
                        <button onClick={()=>setBlocks(blocks.filter(x=>x.id!==b.id))}
                            className="bg-red-500 text-white px-3 py-2 rounded-lg"><Trash2/> Supprimer</button>
                    </div>
                )}

                <div className={active ? "opacity-30" : ""}>
                    <div className="text-sm text-gray-500 mb-2">{b.title}</div>
                    <div className="text-3xl font-bold">{b.value}</div>
                </div>
            </div>
        );
    };

    return (
        <div className="p-8 max-w-7xl mx-auto">
            <h1 className="text-3xl font-bold mb-4">Data Sculptor</h1>

            <div className="flex gap-3 mb-6">
                <button onClick={()=>fileInput.current.click()} className="bg-blue-500 text-white px-4 py-2 rounded-lg">
                    <Upload/> Upload fichier
                </button>
                <input ref={fileInput} type="file" hidden onChange={handleFileUpload}/>
                <button onClick={handleAddBlock} className="bg-indigo-500 text-white px-4 py-2 rounded-lg">
                    <Plus/> Ajouter une data
                </button>
                <button onClick={handleExportWord} className="bg-gray-900 text-white px-4 py-2 rounded-lg">
                    üìÑ Word
                </button>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {blocks.map(renderBlock)}
            </div>
        </div>
    );
};

ReactDOM.createRoot(document.getElementById("root")).render(<DataSculptor/>);
</script>
</body>
</html>
